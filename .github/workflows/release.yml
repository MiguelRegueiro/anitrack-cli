name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag_name: ${{ steps.version.outputs.tag_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read and validate version
        id: version
        run: |
          CARGO_VERSION="$(sed -n 's/^version = "\(.*\)"/\1/p' Cargo.toml | head -n1)"
          TAG_NAME="${GITHUB_REF_NAME}"
          TAG_VERSION="${TAG_NAME#v}"

          if [ -z "${CARGO_VERSION}" ]; then
            echo "Failed to read version from Cargo.toml"
            exit 1
          fi

          if [ "${CARGO_VERSION}" != "${TAG_VERSION}" ]; then
            echo "Tag version (${TAG_VERSION}) does not match Cargo.toml (${CARGO_VERSION})"
            exit 1
          fi

          echo "version=${CARGO_VERSION}" >> "${GITHUB_OUTPUT}"
          echo "tag_name=${TAG_NAME}" >> "${GITHUB_OUTPUT}"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run tests
        run: cargo test --all-features --locked

  build-linux-x86_64:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Build release binary
        run: cargo build --release --locked

      - name: Package artifacts
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          ASSET_BASE="anitrack-v${VERSION}-x86_64-unknown-linux-gnu"
          mkdir -p dist
          cp target/release/anitrack dist/anitrack
          tar -C dist -czf "${ASSET_BASE}.tar.gz" anitrack
          sha256sum "${ASSET_BASE}.tar.gz" > "${ASSET_BASE}.tar.gz.sha256"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-assets
          path: |
            anitrack-v${{ needs.validate.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz
            anitrack-v${{ needs.validate.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz.sha256

  github-release:
    runs-on: ubuntu-latest
    needs: [validate, build-linux-x86_64]
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-assets
          path: release-assets

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate.outputs.tag_name }}
          generate_release_notes: true
          files: release-assets/*

  publish-crates:
    runs-on: ubuntu-latest
    needs: validate
    environment: release
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Authenticate with crates.io (OIDC)
        id: crates-auth
        uses: rust-lang/crates-io-auth-action@v1

      - name: Publish to crates.io
        run: cargo publish --locked
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.crates-auth.outputs.token }}

  aur-summary:
    runs-on: ubuntu-latest
    needs: [validate, build-linux-x86_64]
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-assets
          path: release-assets

      - name: Write AUR update summary
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          TAG="${{ needs.validate.outputs.tag_name }}"
          ASSET="anitrack-v${VERSION}-x86_64-unknown-linux-gnu.tar.gz"
          SHA256="$(cut -d' ' -f1 "release-assets/${ASSET}.sha256")"
          URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}/${ASSET}"

          {
            echo "## AUR update values"
            echo ""
            echo "- pkgver: \`${VERSION}\`"
            echo "- source URL: \`${URL}\`"
            echo "- sha256sums: \`${SHA256}\`"
            echo ""
            echo "Use those values in your AUR package repos (\`anitrack\` / \`anitrack-bin\`) and regenerate \`.SRCINFO\`."
          } >> "${GITHUB_STEP_SUMMARY}"
